version: "3.9"

services:
  consul-server:
    image: hashicorp/consul:latest
    container_name: consul-server-vm2
    restart: unless-stopped
    ports:
      - "8501:8500" # Different host port to avoid conflicts
      - "8303:8300" # Different host port for server RPC
      - "8304:8301" # Different host port for Serf LAN
      - "8305:8302" # Different host port for Serf WAN
      - "8601:8600" # Consul DNS TCP
      - "8601:8600/udp" # Consul DNS UDP
    environment:
      - CONSUL_BIND_INTERFACE=eth0
      - CONSUL_CLIENT_INTERFACE=eth0
      - CONSUL_DATACENTER=dc1
    command: >
      agent
      -server
      -bootstrap-expect=3
      -ui
      -client=0.0.0.0
      -bind=0.0.0.0
      -retry-join=consul-server-vm1
      -retry-join=consul-server-vm3
      -datacenter=dc1
      -data-dir=/consul/data
    volumes:
      - consul-data-vm2:/consul/data
      - consul-config-vm2:/consul/config
    networks:
      - patroni-network
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  patroni-postgres:
    image: patroni-postgres:latest
    container_name: patroni-postgres-vm2
    restart: unless-stopped
    ports:
      - "5433:5432" # PostgreSQL port (different from VM1)
      - "8009:8008" # Patroni API port (different from VM1)
    environment:
      - HOSTNAME=patroni-postgres-vm2
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - REPLICATION_PASSWORD=${REPLICATION_PASSWORD}
      - CONSUL_HOST=consul-server-vm1
      - CONSUL_DATACENTER=dc1
      - CONSUL_ACL_TOKEN=${CONSUL_ACL_TOKEN:-}
      - CONNECT_ADDRESS=${CONNECT_ADDRESS_VM2:-}
      - RESTAPI_CONNECT_ADDRESS=${RESTAPI_CONNECT_ADDRESS_VM2:-}
    volumes:
      - patroni-data-vm2:/home/postgres/pgdata
      - ./patroni-config:/etc/patroni:ro
      - ./scripts:/scripts:ro
    networks:
      - patroni-network
    depends_on:
      consul-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "patronictl", "list"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  consul-data-vm2:
    driver: local
  consul-config-vm2:
    driver: local
  patroni-data-vm2:
    driver: local

networks:
  patroni-network:
    external: true
    name: patroni-shared-bridge

version: "3.9"

# =============================================================================
# VM2 - PostgreSQL HA Cluster Node 2
# =============================================================================
# This compose file runs on VM2 and includes:
# - etcd node 2 (part of 3-node etcd cluster)
# - Patroni/Spilo PostgreSQL node 2
#
# IMPORTANT: Copy .env.vm2.example to .env.vm2 and configure before running
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # etcd - Distributed Key-Value Store for Patroni DCS
  # ---------------------------------------------------------------------------
  etcd2:
    image: quay.io/coreos/etcd:v3.5.11
    container_name: etcd2
    hostname: etcd2
    restart: unless-stopped
    ports:
      - "${ETCD_CLIENT_PORT:-2379}:2379"
      - "${ETCD_PEER_PORT:-2380}:2380"
    environment:
      - ETCD_NAME=etcd2
      - ETCD_DATA_DIR=/etcd-data
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://${NODE2_IP:-127.0.0.1}:2379
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://${NODE2_IP:-127.0.0.1}:2380
      - ETCD_INITIAL_CLUSTER=etcd1=http://${NODE1_IP:-127.0.0.1}:2380,etcd2=http://${NODE2_IP:-127.0.0.1}:2380,etcd3=http://${NODE3_IP:-127.0.0.1}:2380
      - ETCD_INITIAL_CLUSTER_TOKEN=etcd-patroni-cluster
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_ENABLE_V2=true
      - ETCD_AUTO_COMPACTION_RETENTION=1
      - ETCD_AUTO_COMPACTION_MODE=periodic
      - ETCD_QUOTA_BACKEND_BYTES=8589934592
    volumes:
      - etcd2-data:/etcd-data
    networks:
      - patroni-net
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ---------------------------------------------------------------------------
  # Patroni - PostgreSQL HA Manager (using Zalando Spilo image)
  # ---------------------------------------------------------------------------
  patroni2:
    image: ghcr.io/zalando/spilo-16:3.2-p2
    container_name: patroni2
    hostname: patroni2
    restart: unless-stopped
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
      - "${PATRONI_API_PORT:-8008}:8008"
    environment:
      # Spilo/Patroni settings
      - SCOPE=postgres-ha
      - PGVERSION=16
      - PGROOT=/home/postgres/pgdata/pgroot
      - PGDATA=/home/postgres/pgdata/pgroot/data
      - PGLOG=/home/postgres/pgdata/pgroot/pg_log
      
      # Patroni settings
      - PATRONI_SCOPE=postgres-ha
      - PATRONI_NAME=patroni2
      - PATRONI_RESTAPI_LISTEN=0.0.0.0:8008
      - PATRONI_RESTAPI_CONNECT_ADDRESS=${NODE2_IP:-127.0.0.1}:8008
      - PATRONI_POSTGRESQL_LISTEN=0.0.0.0:5432
      - PATRONI_POSTGRESQL_CONNECT_ADDRESS=${NODE2_IP:-127.0.0.1}:5432
      - PATRONI_POSTGRESQL_DATA_DIR=/home/postgres/pgdata/pgroot/data
      
      # etcd DCS configuration
      - PATRONI_ETCD3_HOSTS=${NODE1_IP:-127.0.0.1}:2379,${NODE2_IP:-127.0.0.1}:2379,${NODE3_IP:-127.0.0.1}:2379
      
      # PostgreSQL superuser
      - PATRONI_SUPERUSER_USERNAME=postgres
      - PATRONI_SUPERUSER_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      
      # Replication user
      - PATRONI_REPLICATION_USERNAME=replicator
      - PATRONI_REPLICATION_PASSWORD=${REPLICATION_PASSWORD:-replicator}
      
      # Additional settings
      - PATRONI_POSTGRESQL_PARAMETERS_MAX_CONNECTIONS=200
      - PATRONI_POSTGRESQL_PARAMETERS_SHARED_BUFFERS=256MB
      - PATRONI_POSTGRESQL_PARAMETERS_WAL_LEVEL=replica
      - PATRONI_POSTGRESQL_PARAMETERS_HOT_STANDBY=on
      - PATRONI_POSTGRESQL_PARAMETERS_MAX_WAL_SENDERS=10
      - PATRONI_POSTGRESQL_PARAMETERS_MAX_REPLICATION_SLOTS=10
      
      # Spilo-specific
      - SPILO_CONFIGURATION='{"bootstrap":{"dcs":{"ttl":30,"loop_wait":10,"retry_timeout":10,"maximum_lag_on_failover":1048576,"postgresql":{"use_pg_rewind":true,"use_slots":true}}}}'
      - USE_WALG=false
      - ENABLE_WAL_PATH_COMPAT=true
    volumes:
      - patroni2-data:/home/postgres/pgdata
    networks:
      - patroni-net
    depends_on:
      etcd2:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

volumes:
  etcd2-data:
    driver: local
  patroni2-data:
    driver: local

networks:
  patroni-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

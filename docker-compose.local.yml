# =============================================================================
# Local Development - Single Node PostgreSQL with Patroni
# =============================================================================
# For local testing/development only. NOT for production.
#
# Usage:
#   docker compose -f docker-compose.local.yml up -d
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # etcd - Single node for local development
  # ---------------------------------------------------------------------------
  etcd:
    image: quay.io/coreos/etcd:v3.5.11
    container_name: etcd-local
    hostname: etcd-local
    restart: unless-stopped
    ports:
      - "2379:2379"
      - "2380:2380"
    environment:
      - ETCD_NAME=etcd-local
      - ETCD_DATA_DIR=/etcd-data
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd:2379
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd:2380
      - ETCD_INITIAL_CLUSTER=etcd-local=http://etcd:2380
      - ETCD_INITIAL_CLUSTER_TOKEN=etcd-local-token
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_ENABLE_V2=true
    volumes:
      - etcd-local-data:/etcd-data
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - patroni-local

  # ---------------------------------------------------------------------------
  # Patroni - PostgreSQL with Supabase extensions
  # ---------------------------------------------------------------------------
  patroni:
    image: ${PATRONI_IMAGE:-supabase-patroni:latest}
    container_name: patroni-local
    hostname: patroni-local
    restart: unless-stopped
    ports:
      - "5432:5432"
      - "8008:8008"
    environment:
      # Disable cloud provider auto-detection
      - SPILO_PROVIDER=local
      - AWS_REGION=
      - CALLBACK_SCRIPT=

      # Spilo/Patroni settings
      - SCOPE=postgres-local
      - PGVERSION=16

      # Patroni settings
      - PATRONI_SCOPE=postgres-local
      - PATRONI_NAME=patroni-local
      - PATRONI_RESTAPI_LISTEN=0.0.0.0:8008
      - PATRONI_RESTAPI_CONNECT_ADDRESS=patroni:8008
      - PATRONI_POSTGRESQL_LISTEN=0.0.0.0:5432
      - PATRONI_POSTGRESQL_CONNECT_ADDRESS=patroni:5432

      # etcd DCS configuration
      - PATRONI_ETCD3_HOSTS=etcd:2379

      # PostgreSQL superuser
      - PATRONI_SUPERUSER_USERNAME=postgres
      - PATRONI_SUPERUSER_PASSWORD=${POSTGRES_PASSWORD:-postgres}

      # Replication user
      - PATRONI_REPLICATION_USERNAME=replicator
      - PATRONI_REPLICATION_PASSWORD=${REPLICATION_PASSWORD:-replicator}

      # Additional settings
      - PATRONI_POSTGRESQL_PARAMETERS_MAX_CONNECTIONS=200
      - PATRONI_POSTGRESQL_PARAMETERS_SHARED_BUFFERS=256MB
      - PATRONI_POSTGRESQL_PARAMETERS_WAL_LEVEL=replica
      - PATRONI_POSTGRESQL_PARAMETERS_HOT_STANDBY=on

      # Spilo-specific (includes post_init to run Supabase init script)
      - SPILO_CONFIGURATION={"bootstrap":{"dcs":{"ttl":30,"loop_wait":10,"retry_timeout":10,"maximum_lag_on_failover":1048576,"postgresql":{"use_pg_rewind":true,"use_slots":true,"pg_hba":["local all all trust","host all all 0.0.0.0/0 md5","host all all ::0/0 md5","host replication replicator 0.0.0.0/0 md5"]}},"post_init":"/scripts/run-init.sh"}}
      - USE_WALG=false
      - ENABLE_WAL_PATH_COMPAT=true
    volumes:
      - patroni-local-data:/home/postgres/pgdata
    depends_on:
      etcd:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    networks:
      - patroni-local

networks:
  patroni-local:
    driver: bridge

volumes:
  etcd-local-data:
    driver: local
  patroni-local-data:
    driver: local

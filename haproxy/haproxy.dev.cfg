# =============================================================================
# HAProxy Configuration for Single-Host Development Setup
# =============================================================================
# This configuration is for the docker-compose.dev.yml setup
# Uses Docker internal DNS names instead of IP addresses
# =============================================================================

global
    maxconn 1000
    log stdout format raw local0 info
    stats socket /var/run/haproxy.sock mode 660 level admin
    stats timeout 30s

defaults
    mode tcp
    log global
    option tcplog
    option dontlognull
    option redispatch
    retries 3
    timeout connect 10s
    timeout client 30m
    timeout server 30m
    timeout check 5s

# Stats Dashboard - http://localhost:7000/stats
listen stats
    bind *:7000
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats show-legends
    stats show-node
    stats auth admin:admin123
    stats admin if TRUE

# PostgreSQL Primary (Read/Write) - Port 5000
listen postgres_primary
    bind *:5000
    mode tcp
    option httpchk GET /primary
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions

    server patroni1 patroni1:5432 maxconn 100 check port 8008
    server patroni2 patroni2:5432 maxconn 100 check port 8008
    server patroni3 patroni3:5432 maxconn 100 check port 8008

# PostgreSQL Replicas (Read-Only) - Port 5001
listen postgres_replicas
    bind *:5001
    mode tcp
    balance roundrobin
    option httpchk GET /replica
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions

    server patroni1 patroni1:5432 maxconn 100 check port 8008
    server patroni2 patroni2:5432 maxconn 100 check port 8008
    server patroni3 patroni3:5432 maxconn 100 check port 8008

# PostgreSQL Any Node - Port 5002
listen postgres_any
    bind *:5002
    mode tcp
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions

    server patroni1 patroni1:5432 maxconn 100 check port 8008
    server patroni2 patroni2:5432 maxconn 100 check port 8008
    server patroni3 patroni3:5432 maxconn 100 check port 8008

# etcd Cluster - Port 2379
listen etcd
    bind *:2379
    mode tcp
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    default-server inter 3s fall 3 rise 2

    server etcd1 etcd1:2379 check
    server etcd2 etcd2:2379 check
    server etcd3 etcd3:2379 check

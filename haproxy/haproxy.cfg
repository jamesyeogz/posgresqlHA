# =============================================================================
# HAProxy Configuration for PostgreSQL HA Cluster with Patroni
# =============================================================================
# This configuration provides:
# - Automatic detection of PostgreSQL primary via Patroni REST API
# - Read/write routing to primary (port 5000)
# - Read-only routing to replicas with load balancing (port 5001)
# - Stats dashboard (port 7000)
# =============================================================================

# -----------------------------------------------------------------------------
# Global Settings
# -----------------------------------------------------------------------------
global
    maxconn 1000
    log stdout format raw local0 info
    stats socket /var/run/haproxy.sock mode 660 level admin
    stats timeout 30s

# -----------------------------------------------------------------------------
# Default Settings
# -----------------------------------------------------------------------------
defaults
    mode tcp
    log global
    option tcplog
    option dontlognull
    option redispatch
    retries 3
    timeout connect 10s
    timeout client 30m
    timeout server 30m
    timeout check 5s

# -----------------------------------------------------------------------------
# Stats Dashboard
# -----------------------------------------------------------------------------
# Access at: http://<haproxy-ip>:7000/stats
# Default credentials: admin / admin123
listen stats
    bind *:7000
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats show-legends
    stats show-node
    stats auth admin:admin123
    stats admin if TRUE

# -----------------------------------------------------------------------------
# Health Check Endpoint
# -----------------------------------------------------------------------------
# Simple health check endpoint for external monitoring
listen health
    bind *:7001
    mode http
    option httpchk GET /
    http-request return status 200 content-type "text/plain" string "HAProxy OK"

# -----------------------------------------------------------------------------
# PostgreSQL Primary (Read/Write)
# -----------------------------------------------------------------------------
# Routes connections to the current Patroni leader
# Uses Patroni REST API endpoint /primary for health checks
# Only the leader returns HTTP 200 on /primary
listen postgres_primary
    bind *:5000
    mode tcp
    option httpchk GET /primary
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions

    # =========================================================================
    # IMPORTANT: Replace these IPs with your actual VM IPs!
    # NODE1_IP = Your VM1 IP (e.g., 192.168.x.x or 10.0.x.x)
    # NODE2_IP = Your VM2 IP
    # NODE3_IP = Your VM3 IP
    # =========================================================================
    server patroni1 NODE1_IP:5432 maxconn 100 check port 8008
    server patroni2 NODE2_IP:5432 maxconn 100 check port 8008
    server patroni3 NODE3_IP:5432 maxconn 100 check port 8008

# -----------------------------------------------------------------------------
# PostgreSQL Replicas (Read-Only)
# -----------------------------------------------------------------------------
listen postgres_replicas
    bind *:5001
    mode tcp
    balance roundrobin
    option httpchk GET /replica
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions

    server patroni1 NODE1_IP:5432 maxconn 100 check port 8008
    server patroni2 NODE2_IP:5432 maxconn 100 check port 8008
    server patroni3 NODE3_IP:5432 maxconn 100 check port 8008

# -----------------------------------------------------------------------------
# PostgreSQL Any Node (Read-Only with Primary Fallback)
# -----------------------------------------------------------------------------
listen postgres_any
    bind *:5002
    mode tcp
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions

    server patroni1 NODE1_IP:5432 maxconn 100 check port 8008
    server patroni2 NODE2_IP:5432 maxconn 100 check port 8008
    server patroni3 NODE3_IP:5432 maxconn 100 check port 8008

# =============================================================================
# HAProxy Configuration for PostgreSQL HA Cluster with Patroni
# =============================================================================
# This configuration provides:
# - Automatic detection of PostgreSQL primary via Patroni REST API
# - Read/write routing to primary (port 5000)
# - Read-only routing to replicas with load balancing (port 5001)
# - Stats dashboard (port 7000)
# =============================================================================

# -----------------------------------------------------------------------------
# Global Settings
# -----------------------------------------------------------------------------
global
    maxconn 1000
    log stdout format raw local0 info
    stats socket /var/run/haproxy.sock mode 660 level admin
    stats timeout 30s

# -----------------------------------------------------------------------------
# Default Settings
# -----------------------------------------------------------------------------
defaults
    mode tcp
    log global
    option tcplog
    option dontlognull
    option redispatch
    retries 3
    timeout connect 10s
    timeout client 30m
    timeout server 30m
    timeout check 5s

# -----------------------------------------------------------------------------
# Stats Dashboard
# -----------------------------------------------------------------------------
# Access at: http://<haproxy-ip>:7000/stats
# Default credentials: admin / admin123
listen stats
    bind *:7000
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats show-legends
    stats show-node
    stats auth admin:admin123
    stats admin if TRUE

# -----------------------------------------------------------------------------
# Health Check Endpoint
# -----------------------------------------------------------------------------
# Simple health check endpoint for external monitoring
listen health
    bind *:7001
    mode http
    option httpchk GET /
    http-request return status 200 content-type "text/plain" string "HAProxy OK"

# -----------------------------------------------------------------------------
# PostgreSQL Primary (Read/Write)
# -----------------------------------------------------------------------------
# Routes connections to the current Patroni leader
# Uses Patroni REST API endpoint /primary for health checks
# Only the leader returns HTTP 200 on /primary
listen postgres_primary
    bind *:5000
    mode tcp
    option httpchk GET /primary
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions

    # Backend servers - Update IPs to match your environment
    # Format: server <name> <ip>:<pg_port> maxconn <max> check port <patroni_api_port>
    server patroni1 192.168.1.101:5432 maxconn 100 check port 8008
    server patroni2 192.168.1.102:5432 maxconn 100 check port 8008
    server patroni3 192.168.1.103:5432 maxconn 100 check port 8008

# -----------------------------------------------------------------------------
# PostgreSQL Replicas (Read-Only)
# -----------------------------------------------------------------------------
# Routes connections to replica nodes using round-robin
# Uses Patroni REST API endpoint /replica for health checks
# Only replicas return HTTP 200 on /replica
# Primary is included as backup in case all replicas are down
listen postgres_replicas
    bind *:5001
    mode tcp
    balance roundrobin
    option httpchk GET /replica
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions

    # Backend servers - Update IPs to match your environment
    # Format: server <name> <ip>:<pg_port> maxconn <max> check port <patroni_api_port>
    server patroni1 192.168.1.101:5432 maxconn 100 check port 8008
    server patroni2 192.168.1.102:5432 maxconn 100 check port 8008
    server patroni3 192.168.1.103:5432 maxconn 100 check port 8008

# -----------------------------------------------------------------------------
# PostgreSQL Any Node (Read-Only with Primary Fallback)
# -----------------------------------------------------------------------------
# Routes to any healthy node - useful when you just need a connection
# Prefers replicas but will use primary if no replicas available
listen postgres_any
    bind *:5002
    mode tcp
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions

    # Backend servers
    server patroni1 192.168.1.101:5432 maxconn 100 check port 8008
    server patroni2 192.168.1.102:5432 maxconn 100 check port 8008
    server patroni3 192.168.1.103:5432 maxconn 100 check port 8008

# -----------------------------------------------------------------------------
# etcd Cluster (Optional - for monitoring)
# -----------------------------------------------------------------------------
# Provides a single endpoint to reach any etcd node
listen etcd
    bind *:2379
    mode tcp
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    default-server inter 3s fall 3 rise 2

    server etcd1 192.168.1.101:2379 check
    server etcd2 192.168.1.102:2379 check
    server etcd3 192.168.1.103:2379 check

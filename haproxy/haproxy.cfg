global
    maxconn 100
    log stdout local0

defaults
    log global
    retries 2
    timeout client 30m
    timeout connect 4s
    timeout server 30m
    timeout check 5s

# Stats interface
listen stats
    mode http
    bind *:7000
    stats enable
    stats uri /
    stats refresh 30s
    stats realm HAProxy\ Statistics

# Health check endpoint for K8s probes
listen health
    mode http
    bind *:7001
    http-request return status 200 content-type "text/plain" string "OK" if { path /health }
    http-request return status 404

# PostgreSQL Master (Read/Write)
# Uses Patroni REST API to detect master via HTTP health checks
# Each Patroni instance exposes REST API on ports 8008, 8009, 8010 respectively
listen postgres_master
    bind *:5432
    mode tcp
    option httpchk GET /master
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    # Check Patroni REST API on port 8008/8009/8010, connect to PostgreSQL on 5432/5433/5434
    server patroni-vm1 host.docker.internal:5432 maxconn 100 check port 8008
    server patroni-vm2 host.docker.internal:5433 maxconn 100 check port 8009
    server patroni-vm3 host.docker.internal:5434 maxconn 100 check port 8010

# PostgreSQL Replicas (Read Only)
# Uses Patroni REST API to detect replicas via HTTP health checks
listen postgres_replicas
    bind *:5001
    mode tcp
    option httpchk GET /replica
    http-check expect status 200
    balance roundrobin
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    # Check Patroni REST API on port 8008/8009/8010, connect to PostgreSQL on 5432/5433/5434
    server patroni-vm1 host.docker.internal:5432 maxconn 100 check port 8008
    server patroni-vm2 host.docker.internal:5433 maxconn 100 check port 8009
    server patroni-vm3 host.docker.internal:5434 maxconn 100 check port 8010

# Consul Cluster (API + UI)
listen consul
    bind *:8500
    mode http
    balance roundrobin
    option http-server-close
    option forwardfor
    option httpchk GET /v1/status/leader
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    server consul-vm1 host.docker.internal:8500 check
    server consul-vm2 host.docker.internal:8501 check
    server consul-vm3 host.docker.internal:8502 check
version: "3.9"

# =============================================================================
# HAProxy - Load Balancer for PostgreSQL HA Cluster
# =============================================================================
# This compose file provides a load balancer that:
# - Routes read/write traffic to the current primary (port 5000)
# - Routes read-only traffic to replicas with round-robin (port 5001)
# - Provides a stats dashboard (port 7000)
#
# IMPORTANT: Copy .env.haproxy.example to .env.haproxy and configure before running
# =============================================================================

services:
  haproxy:
    image: haproxy:2.9-alpine
    container_name: haproxy
    hostname: haproxy
    restart: unless-stopped
    network_mode: host # Use host network to reach Patroni instances on VMs
    # ports not needed with network_mode: host (uses host ports directly: 5000, 5001, 5002, 7000)
    volumes:
      - ./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    healthcheck:
      test: ["CMD", "haproxy", "-c", "-f", "/usr/local/etc/haproxy/haproxy.cfg"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
